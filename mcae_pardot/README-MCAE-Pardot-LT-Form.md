# Pardot Integration 
## Layout Template Form Tab

### Change these two things: https://your-wp-domain.com and PASTE_YOUR_API_KEY_HERE
```
<style type="text/css">
    /* --- Modern Form Styles --- */
    #pardot-form {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        color: #333;
        padding: 20px; /* Add some padding around the form */
        background-color: #f9f9f9; /* Optional: light background for the form area */
        border-radius: 8px; /* Optional: rounded corners */
        max-width: 600px; /* Optional: constrain form width */
        margin: 20px auto; /* Optional: center form on page */
    }

    /* General error message at the top */
    #pardot-form p.errors { /* Pardot's default error wrapper */
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 0.9em;
    }

    /* Form field wrapper */
    #pardot-form p.form-field {
        margin-bottom: 20px; /* Space between fields */
        padding: 0; /* Reset Pardot default padding if any */
    }

    /* Field Label - Positioned on top */
    #pardot-form label.field-label {
        display: block; /* Makes the label take its own line */
        font-weight: 600;
        margin-bottom: 8px; /* Space between label and input */
        font-size: 0.95em;
        color: #333;
    }

    /* Input fields, textareas, selects */
    #pardot-form input[type="text"],
    #pardot-form input[type="email"],
    #pardot-form input[type="tel"],
    #pardot-form input[type="url"],
    #pardot-form input[type="password"],
    #pardot-form input[type="number"],
    #pardot-form input[type="date"],
    #pardot-form textarea,
    #pardot-form select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* Important for 100% width + padding */
        font-size: 1em;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    #pardot-form textarea {
        min-height: 100px;
        resize: vertical;
    }
    #pardot-form input:focus,
    #pardot-form textarea:focus,
    #pardot-form select:focus {
        border-color: #007bff; /* Highlight color on focus */
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        outline: none;
    }

    /* Field descriptions */
    #pardot-form span.description {
        display: block;
        font-size: 0.85em;
        color: #666;
        margin-top: 6px;
    }

    /* Field-specific error messages (Pardot's default) */
    #pardot-form p.error.no-label { /* This is how Pardot typically renders field-specific errors */
        color: #c0392b; /* Red for errors */
        font-size: 0.85em;
        margin-top: 6px;
        margin-bottom: 0;
    }
    /* Highlight fields with Pardot errors */
    #pardot-form p.form-field.error input,
    #pardot-form p.form-field.error textarea,
    #pardot-form p.form-field.error select {
        border-color: #c0392b;
    }

    /* Error messages generated by THIS custom script */
    #pardot-form .pardot-block-error-message { /* Class added by your script */
        color: #c0392b;
        font-size: 0.85em;
        margin-top: 6px;
        display: block; /* Ensure it's visible */
    }
    /* Style for the specific error div used by the script */
    #pardot-form div[id^="custom_error_for_"] { /* Changed ID prefix to avoid conflict */
        margin-top: 5px;
    }


    /* Checkbox and Radio button styling */
    #pardot-form .checkbox label,
    #pardot-form .radio label {
        font-weight: normal;
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
    }
    #pardot-form .checkbox input[type="checkbox"],
    #pardot-form .radio input[type="radio"] {
        width: auto;
        margin-right: 8px;
        margin-top:0;
    }
    #pardot-form p.form-field p { /* If Pardot wraps options in <p> */
        margin-bottom: 5px;
    }


    /* Submit button */
    #pardot-form p.submit {
        margin-top: 25px;
        text-align: left;
    }
    #pardot-form p.submit input[type="submit"] {
        background-color: #007bff;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 4px;
        font-size: 1.05em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    #pardot-form p.submit input[type="submit"]:hover {
        background-color: #0056b3;
    }
    #pardot-form p.submit input[type="submit"]:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #pardot-form .hidden { display: none !important; }

    #pardot-form .form-success,
    #pardot-form .form_thank_you_message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 15px;
        border-radius: 4px;
        text-align: center;
    }
</style>

<form accept-charset="UTF-8" method="post" action="%%form-action-url%%" class="form" id="pardot-form">
    %%form-opening-general-content%%

    %%form-if-thank-you%%
        %%form-javascript-focus%%
        <div class="form_thank_you_message">
            %%form-thank-you-content%%
        </div>
        %%form-thank-you-code%%
    %%form-end-if-thank-you%%

    %%form-if-display-form%%
        %%form-before-form-content%%
            %%form-if-error%%
                <p class="errors">Please correct the errors below:</p>
            %%form-end-if-error%%

            %%form-start-loop-fields%%
                <p class="form-field %%form-field-css-classes%% %%form-field-class-type%% %%form-field-class-required%% %%form-field-class-hidden%% %%form-field-class-no-label%% %%form-field-class-error%% %%form-field-dependency-css%%">
                    %%form-if-field-label%%
                        <label class="field-label" for="%%form-field-id%%">%%form-field-label%%</label>
                    %%form-end-if-field-label%%

                    %%form-field-input%%
                    %%form-if-field-description%%
                        <span class="description">%%form-field-description%%</span>
                    %%form-end-if-field-description%%

                    %%form-field-if-error%%
                        <p class="error no-label">%%form-field-error-message%%</p>
                    %%form-field-end-if-error%%
                </p>
                <!-- Div for custom script's error messages for this field -->
                <div id="custom_error_for_%%form-field-id%%" style="display:none;"></div>
            %%form-end-loop-fields%%

            %%form-spam-trap-field%%
            <input name="_utf8" type="hidden" value="â˜ƒ" />

            <p class="submit">
                <input type="submit" accesskey="s" value="%%form-submit-button-text%%" %%form-submit-disabled%%/>
            </p>
        %%form-after-form-content%%
    %%form-end-if-display-form%%

    %%form-javascript-link-target-top%%

          <!-- ADVANCED FORMS BLOCKER SCRIPT -->
    <script type="text/javascript">
    // Ensure this script runs after jQuery is loaded (Pardot layout templates typically include jQuery)
    if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function($) {
            // --- CONFIGURATION: User needs to update these ---
            const YOUR_WORDPRESS_SITE_BASE_URL = 'https://your-wp-domain.com'; // CONFIRMED
            const YOUR_API_KEY = 'PASTE_YOUR_API_KEY_HERE';     // CONFIRMED
            // --- END CONFIGURATION ---

            const wordpressApiUrlBase = YOUR_WORDPRESS_SITE_BASE_URL.replace(/\/+$/, "") + '/wp-json/afb/v1/list';
            let blockedDomains = [];
            let blockedEmails = [];
            let customMessages = {
                blocked_email: 'This email address is not allowed for submission.',
                blocked_domain: 'Submissions from this email domain are not allowed.'
            };
            let blocklistLoaded = false;
            const form = $('#pardot-form');

            function fetchBlocklist() {
                if (!YOUR_API_KEY || YOUR_API_KEY === 'PASTE_YOUR_API_KEY_HERE') {
                    blocklistLoaded = false;
                    return;
                }
                if (!YOUR_WORDPRESS_SITE_BASE_URL || YOUR_WORDPRESS_SITE_BASE_URL === 'https://your-wp-domain.com') {
                    blocklistLoaded = false;
                    return;
                }

                const fullApiUrl = wordpressApiUrlBase + '?key=' + YOUR_API_KEY;

                $.ajax({
                    url: fullApiUrl,
                    method: 'GET',
                    dataType: 'json',
                    timeout: 10000,
                    success: function(data) {
                        if (data && Array.isArray(data.domains) && Array.isArray(data.emails) && data.messages && typeof data.messages === 'object') {
                            blockedDomains = data.domains.map(domain => domain.toLowerCase());
                            blockedEmails = data.emails.map(email => email.toLowerCase());
                            
                            customMessages.blocked_email = data.messages.blocked_email || customMessages.blocked_email;
                            customMessages.blocked_domain = data.messages.blocked_domain || customMessages.blocked_domain;

                            blocklistLoaded = true;
                        } else {
                            blocklistLoaded = false;
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        blocklistLoaded = false;
                    }
                });
            }

            fetchBlocklist();

            function showBlockError(message, fieldElement) {
                const fieldIdRaw = fieldElement.attr('id') || fieldElement.attr('name');
                if (!fieldIdRaw) {
                    const generalErrorArea = form.find('p.errors');
                    if (generalErrorArea.length && !generalErrorArea.is(':visible')) {
                        generalErrorArea.text(message).show();
                    } else if (generalErrorArea.length) {
                        generalErrorArea.html(generalErrorArea.html() + '<br>' + message);
                    }
                    fieldElement.css('border-color', '#c0392b');
                    return;
                }
                const errorDivId = 'custom_error_for_' + fieldIdRaw.replace(/[^a-zA-Z0-9_]/g, '_');
                let errorArea = $('#' + errorDivId);

                if (!errorArea.length) {
                    // Ensure the error div is placed correctly after the <p class="form-field">
                    const fieldWrapper = fieldElement.closest('p.form-field');
                    if (fieldWrapper.length) {
                        fieldWrapper.after('<div id="' + errorDivId + '" class="pardot-block-error-message" style="display:none;"></div>');
                        errorArea = $('#' + errorDivId);
                    } else { // Fallback if p.form-field isn't the direct parent
                        fieldElement.after('<div id="' + errorDivId + '" class="pardot-block-error-message" style="display:none;"></div>');
                        errorArea = $('#' + errorDivId);
                    }
                }
                
                errorArea.text(message).addClass('pardot-block-error-message').show();
                fieldElement.css('border-color', '#c0392b');
            }

            function clearBlockError(fieldElement) {
                const fieldIdRaw = fieldElement.attr('id') || fieldElement.attr('name');
                if (!fieldIdRaw) return;
                const errorDivId = 'custom_error_for_' + fieldIdRaw.replace(/[^a-zA-Z0-9_]/g, '_');
                $('#' + errorDivId).text('').hide().removeClass('pardot-block-error-message');
                fieldElement.css('border-color', '');
            }

            form.on('submit', function(e) {
                if (!blocklistLoaded) {
                    return true; // Allow submission if blocklist isn't loaded
                }

                const emailField = form.find('p.form-field.email input[type="text"]').first(); 

                if (!emailField.length) {
                    return true; // Allow submission if email field is not found
                }

                const emailValue = emailField.val().trim().toLowerCase();
                clearBlockError(emailField);

                if (!emailValue) {
                    return true; // Allow submission if email field is empty (Pardot will validate)
                }

                let isBlocked = false;
                let blockMessage = '';

                if (blockedEmails.includes(emailValue)) {
                    isBlocked = true;
                    blockMessage = customMessages.blocked_email;
                }

                if (!isBlocked) {
                    const emailParts = emailValue.split('@');
                    if (emailParts.length === 2) {
                        const domain = emailParts[1];
                        if (blockedDomains.includes(domain)) {
                            isBlocked = true;
                            blockMessage = customMessages.blocked_domain;
                        }
                    }
                }

                if (isBlocked) {
                    e.preventDefault();
                    showBlockError(blockMessage, emailField);
                    return false;
                }
                return true;
            });

            // Optional: Validate on blur
            form.on('blur', 'p.form-field.email input[type="text"]', function() {
                if (!blocklistLoaded) return;

                const emailField = $(this);
                const emailValue = emailField.val().trim().toLowerCase();
                clearBlockError(emailField);

                if (!emailValue) return;

                let isBlocked = false;
                let blockMessage = '';

                if (blockedEmails.includes(emailValue)) {
                    isBlocked = true;
                    blockMessage = customMessages.blocked_email;
                }
                if (!isBlocked) {
                    const emailParts = emailValue.split('@');
                    if (emailParts.length === 2) {
                        const domain = emailParts[1];
                        if (blockedDomains.includes(domain)) {
                            isBlocked = true;
                            blockMessage = customMessages.blocked_domain;
                        }
                    }
                }
                if (isBlocked) {
                    showBlockError(blockMessage, emailField);
                }
            });
        });
    }
    </script>
</form>
```